# Testing

SGPE includes a comprehensive test suite called "Battle" that verifies correctness, measures performance, and compares against other tokenizers.

## Running Tests

### Interactive Mode

```bash
python tests/orchestrator.py
```

This opens an interactive menu:

```
┌────┬──────────────────────────────────────┐
│ ID │ Test                                 │
├────┼──────────────────────────────────────┤
│ 1  │ Linguistic Complexity (2K words)    │
│ 2  │ Glitched Token Detection            │
│ 3  │ Frontier Benchmarking               │
│ 4  │ Round-Trip Consistency              │
│ 5  │ Boundary & Leading Space Edge-Cases │
│ 6  │ Zero-Breakage Guarantee (Extended)  │
│ 7  │ Run ALL Tests                       │
│ C  │ Configure Paths                     │
│ Q  │ Quit                                │
└────┴──────────────────────────────────────┘
```

### Command Line Mode

Run tests directly with `battle.py`:

```bash
# Run specific batteries
python tests/battle.py --vocab_file output/vocab.json --test_file data/test.jsonl --only complexity

# Full evaluation (no API tests)
python tests/battle.py --vocab_file output/vocab.json --test_file data/test.jsonl --full_eval

# Skip round-trip (it's slow)
python tests/battle.py --skip_roundtrip
```

## Test Batteries

### Battery 1: Linguistic Complexity

Tests 2,000 complex Sanskrit/Pali-derived Sinhala words including:
- Triple conjuncts (e.g., ක්‍රෝෂ්ඨ)
- Yansaya/Rakaransaya forms
- Stacked viramas
- Mixed conjunct + pili + anusvara

**Expected:** Zero violations — every complex word should be segmented as atomic syllables.

### Battery 2: Glitched Token Detection

Scans the vocabulary for:
- Zero-usage tokens
- Near-zero usage tokens
- Bare ZWJ/HAL artifacts
- Encoding errors or infinite loops

**Expected:** Zero critical issues. Some warning-level issues may be flagged.

### Battery 3: Frontier Benchmarking

Compares SGPE against:
- OpenAI o200k_base (GPT-4o, o3, o4)
- Llama 4 Scout (HuggingFace)
- DeepSeek V3 (HuggingFace)
- Gemini/Claude (optional, requires API keys)

Two modes:
- **Sampled** (default): 500 sentences, includes API tokenizers
- **Full**: All sentences in test set, local tokenizers only

**Expected:** SGPE should show ~60% token reduction vs GPT-4o.

### Battery 4: Round-Trip Consistency

Encodes then decodes up to 1 million sentences and verifies:
- No data loss (except known [UNK] replacements)
- No crashes
- Consistent output

**Expected:** Zero non-UNK mismatches.

### Battery 5: Boundary & Leading Space Edge Cases

Tests 60+ edge cases:
- Multiple leading/trailing spaces
- Mixed Sinhala + English + numbers
- Unicode edge cases (BOM, RTL marks, etc.)
- Leading space prefix integrity

**Expected:** Zero violations.

### Battery 6: Zero-Breakage Exhaustive

Exhaustively tests all valid Sinhala grapheme combinations:
- C + HAL + ZWJ + C (yansaya/rakaransaya)
- C + HAL + C (implicit conjunct)
- C + vowel_sign
- C + HAL (terminal virama)
- C + anusvara/visarga
- Triple stacks

**Expected:** Zero violations — this is the core guarantee.

## Interpreting Results

Each battery returns:
- **PASS**: All criteria met
- **FAIL**: Issues found
- **WARN**: Quality concerns (e.g., high dead token percentage)

## Environment Variables

For frontier benchmarking, set these in `.env`:

```bash
GEMINI_API_KEY=your_key_here
ANTHROPIC_API_KEY=your_key_here
HF_TOKEN=your_token_here
```

Without API keys, the benchmarking test will skip those tokenizers.

## Continuous Integration

To run tests in CI:

```bash
# Quick test (no round-trip)
python tests/battle.py \
    --vocab_file output/vocab.json \
    --test_file data/test.jsonl \
    --only complexity glitched boundary zerobreak

# Full benchmark
python tests/battle.py \
    --vocab_file output/vocab.json \
    --test_file data/test.jsonl \
    --full_eval
```
